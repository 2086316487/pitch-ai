'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { FileText, Download, ArrowLeft, Loader2, FileSpreadsheet, FileDown } from 'lucide-react';
import { exportBusinessPlanToPDF, exportBusinessPlanToText } from '@/lib/utils/pdfExport';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';

export default function BusinessPlanPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isGenerating, setIsGenerating] = useState(false);
  const [planData, setPlanData] = useState<any>(null);
  const [error, setError] = useState('');
  const contentEndRef = useRef<HTMLDivElement>(null);

  // ä» URL å‚æ•°è·å–å•†ä¸šè¦ç´ æ•°æ®
  const elementsParam = searchParams.get('elements');

  // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
  useEffect(() => {
    if (isGenerating && contentEndRef.current) {
      contentEndRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }, [planData?.content, isGenerating]);

  const generateFullPlan = async () => {
    if (!elementsParam) {
      setError('ç¼ºå°‘å•†ä¸šè¦ç´ æ•°æ®');
      return;
    }

    setIsGenerating(true);
    setError('');

    try {
      const elements = JSON.parse(decodeURIComponent(elementsParam));

      const response = await fetch('/api/generate-full-plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          elements,
          title: 'å•†ä¸šè®¡åˆ’ä¹¦',
          stream: true, // å¯ç”¨æµå¼è¾“å‡º
        }),
      });

      if (!response.ok) {
        throw new Error('ç”Ÿæˆå¤±è´¥');
      }

      const reader = response.body?.getReader();
      const decoder = new TextDecoder();

      if (!reader) {
        throw new Error('ï¿½ï¿½æ³•è¯»å–å“åº”æµ');
      }

      let accumulatedContent = '';
      let metadata: any = null;
      let buffer = ''; // ç¼“å†²åŒºç”¨äºå¤„ç†è¢«æˆªæ–­çš„æ•°æ®

      while (true) {
        const { done, value } = await reader.read();

        if (done) break;

        // å°†æ–°æ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒº
        buffer += decoder.decode(value, { stream: true });

        // æŒ‰è¡Œåˆ†å‰²ï¼Œä½†ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ
        const lines = buffer.split('\n');
        buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªæœªå®Œæˆçš„è¡Œ

        for (const line of lines) {
          const trimmedLine = line.trim();

          // è·³è¿‡ç©ºè¡Œ
          if (!trimmedLine) continue;

          if (trimmedLine.startsWith('data: ')) {
            try {
              const jsonStr = trimmedLine.slice(6);
              const jsonData = JSON.parse(jsonStr);

              if (jsonData.type === 'metadata') {
                metadata = jsonData.data;
              } else if (jsonData.type === 'content') {
                accumulatedContent += jsonData.data;
                // å®æ—¶æ›´æ–°æ˜¾ç¤º
                if (metadata) {
                  setPlanData({
                    ...metadata,
                    content: accumulatedContent,
                  });
                }
              } else if (jsonData.type === 'done') {
                // ç”Ÿæˆå®Œæˆ
                if (metadata) {
                  setPlanData({
                    ...metadata,
                    content: jsonData.data.fullContent || accumulatedContent,
                  });
                }
              } else if (jsonData.type === 'error') {
                throw new Error(jsonData.data.message);
              }
            } catch (e) {
              // åªåœ¨å¼€å‘ç¯å¢ƒæ‰“å°è§£æé”™è¯¯
              if (process.env.NODE_ENV === 'development') {
                console.warn('è§£æ SSE æ•°æ®å¤±è´¥:', trimmedLine, e);
              }
            }
          }
        }
      }

    } catch (err) {
      console.error('ç”Ÿæˆå¤±è´¥:', err);
      setError(err instanceof Error ? err.message : 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsGenerating(false);
    }
  };

  // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç”Ÿæˆ
  useEffect(() => {
    if (elementsParam && !planData && !isGenerating) {
      generateFullPlan();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const handleExportPDF = async () => {
    if (!planData) {
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
      return;
    }

    // æ˜¾ç¤ºåŠ è½½æç¤º
    const loadingToast = document.createElement('div');
    loadingToast.innerHTML = 'æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...';
    loadingToast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    document.body.appendChild(loadingToast);

    try {
      // æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—
      console.log('å¼€å§‹å¯¼å‡ºPDF...');

      const result = await exportBusinessPlanToPDF(planData);

      // ç§»é™¤åŠ è½½æç¤º
      document.body.removeChild(loadingToast);

      if (result.success) {
        // PDF å·²è‡ªåŠ¨ä¸‹è½½
        console.log('PDF å¯¼å‡ºæˆåŠŸ:', result.fileName);

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const successToast = document.createElement('div');
        successToast.innerHTML = 'âœ… PDF å¯¼å‡ºæˆåŠŸï¼';
        successToast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        document.body.appendChild(successToast);
        setTimeout(() => {
          document.body.removeChild(successToast);
        }, 3000);
      } else {
        alert('PDF å¯¼å‡ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
      }
    } catch (error) {
      console.error('PDF å¯¼å‡ºé”™è¯¯:', error);
      // ç§»é™¤åŠ è½½æç¤ºï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
      if (document.body.contains(loadingToast)) {
        document.body.removeChild(loadingToast);
      }
      alert('PDF å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };

  const handleExportPPT = async () => {
    if (!planData) {
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
      return;
    }

    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const loadingToast = document.createElement('div');
      loadingToast.innerHTML = 'æ­£åœ¨ç”ŸæˆPPTï¼Œè¯·ç¨å€™...';
      loadingToast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      document.body.appendChild(loadingToast);

      // è°ƒç”¨ API ç”Ÿæˆ PPT
      const response = await fetch('/api/generate-ppt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: planData.title,
          elements: planData.elements,
          content: planData.content,
          createdAt: planData.createdAt,
        }),
      });

      if (!response.ok) {
        throw new Error('PPT ç”Ÿæˆå¤±è´¥');
      }

      // è·å–æ–‡ä»¶æ•°æ®
      const blob = await response.blob();

      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${planData.title}_${new Date().getTime()}.pptx`;
      document.body.appendChild(a);
      a.click();

      // æ¸…ç†
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      document.body.removeChild(loadingToast);

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      const successToast = document.createElement('div');
      successToast.innerHTML = 'âœ… PPT ç”ŸæˆæˆåŠŸï¼';
      successToast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      document.body.appendChild(successToast);
      setTimeout(() => {
        document.body.removeChild(successToast);
      }, 3000);

    } catch (error) {
      console.error('PPT ç”Ÿæˆé”™è¯¯:', error);
      alert('PPT ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };

  const handleExportText = () => {
    if (!planData) {
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
      return;
    }

    const result = exportBusinessPlanToText(planData);
    if (result.success) {
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      const successToast = document.createElement('div');
      successToast.innerHTML = 'âœ… æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼';
      successToast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      document.body.appendChild(successToast);
      setTimeout(() => {
        document.body.removeChild(successToast);
      }, 3000);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white border-b sticky top-0 z-50">
        <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
          <button
            onClick={() => router.push('/')}
            className="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
          >
            <ArrowLeft className="w-5 h-5" />
            è¿”å›é¦–é¡µ
          </button>
          <div className="flex items-center gap-2">
            <FileText className="w-6 h-6 text-blue-600" />
            <h1 className="text-xl font-bold text-gray-900">å®Œæ•´å•†ä¸šè®¡åˆ’ä¹¦</h1>
          </div>
          {planData && (
            <div className="flex gap-2">
              <button
                onClick={handleExportPPT}
                className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
              >
                <FileSpreadsheet className="w-4 h-4" />
                å¯¼å‡º PPT
              </button>
              <button
                onClick={handleExportPDF}
                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Download className="w-4 h-4" />
                å¯¼å‡º PDF
              </button>
              <button
                onClick={handleExportText}
                className="flex items-center gap-2 px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                title="å¦‚æœPDFæœ‰ä¹±ç ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬æ ¼å¼"
              >
                <FileDown className="w-4 h-4" />
                TXT
              </button>
            </div>
          )}
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-5xl mx-auto px-4 py-8">
        {/* Loading State */}
        {isGenerating && !planData && (
          <div className="bg-white rounded-xl shadow-sm p-12 text-center">
            <Loader2 className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-4" />
            <h2 className="text-xl font-semibold text-gray-900 mb-2">
              AI æ­£åœ¨ç”Ÿæˆå®Œæ•´å•†ä¸šè®¡åˆ’ä¹¦...
            </h2>
            <p className="text-gray-600">
              ä½¿ç”¨æµå¼è¾“å‡ºæŠ€æœ¯ï¼Œæ‚¨å°†å®æ—¶çœ‹åˆ°å†…å®¹ç”Ÿæˆè¿‡ç¨‹
            </p>
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
            <p className="text-red-600 font-semibold mb-4">{error}</p>
            <button
              onClick={generateFullPlan}
              className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
            >
              é‡æ–°ç”Ÿæˆ
            </button>
          </div>
        )}

        {/* Plan Content */}
        {planData && (
          <div id="business-plan-content" className="bg-white rounded-xl shadow-sm">
            {/* Cover Page */}
            <div className="border-b p-12 text-center bg-gradient-to-br from-blue-50 to-purple-50">
              <h1 className="text-4xl font-bold text-gray-900 mb-4">
                {planData.title}
              </h1>
              <p className="text-lg text-gray-600">
                ç”Ÿæˆæ—¶é—´ï¼š{new Date(planData.createdAt).toLocaleDateString('zh-CN', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </p>
            </div>

            {/* Business Elements Summary */}
            <div className="p-8 border-b">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">
                ğŸ“‹ æ‰§è¡Œæ‘˜è¦
              </h2>

              <div className="space-y-6">
                <div>
                  <h3 className="text-lg font-semibold text-blue-600 mb-2">
                    ğŸ¯ æ ¸å¿ƒé—®é¢˜
                  </h3>
                  <p className="text-gray-700 leading-relaxed">
                    {planData.elements.problem}
                  </p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-green-600 mb-2">
                    ğŸ’¡ è§£å†³æ–¹æ¡ˆ
                  </h3>
                  <p className="text-gray-700 leading-relaxed">
                    {planData.elements.solution}
                  </p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-purple-600 mb-2">
                    ğŸ‘¥ ç›®æ ‡ç”¨æˆ·
                  </h3>
                  <p className="text-gray-700 leading-relaxed">
                    {planData.elements.targetUsers}
                  </p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-orange-600 mb-2">
                    â­ ä»·å€¼ä¸»å¼ 
                  </h3>
                  <p className="text-gray-700 leading-relaxed">
                    {planData.elements.valueProposition}
                  </p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-indigo-600 mb-2">
                    ğŸ’° å•†ä¸šæ¨¡å¼
                  </h3>
                  <p className="text-gray-700 leading-relaxed">
                    {planData.elements.businessModel}
                  </p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-teal-600 mb-2">
                    ğŸ“Š å¸‚åœºè§„æ¨¡
                  </h3>
                  <p className="text-gray-700 leading-relaxed">
                    {planData.elements.marketSize}
                  </p>
                </div>

                {planData.elements.competitors && planData.elements.competitors.length > 0 && (
                  <div>
                    <h3 className="text-lg font-semibold text-red-600 mb-2">
                      ğŸ” ä¸»è¦ç«äº‰å¯¹æ‰‹
                    </h3>
                    <ul className="list-disc list-inside text-gray-700 space-y-1">
                      {planData.elements.competitors.map((competitor: string, index: number) => (
                        <li key={index}>{competitor}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>

            {/* AI Generated Full Plan */}
            <div className="p-8">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">
                ğŸ“„ è¯¦ç»†è®¡åˆ’ä¹¦å†…å®¹
              </h2>

              <div className="prose prose-lg max-w-none text-gray-700 leading-relaxed relative">
                <ReactMarkdown
                  remarkPlugins={[remarkGfm]}
                  className="markdown-content"
                  components={{
                    // è‡ªå®šä¹‰æ ·å¼
                    h1: ({ node, ...props }) => <h1 className="text-3xl font-bold mt-8 mb-4 text-gray-900" {...props} />,
                    h2: ({ node, ...props }) => <h2 className="text-2xl font-semibold mt-6 mb-3 text-gray-800" {...props} />,
                    h3: ({ node, ...props }) => <h3 className="text-xl font-semibold mt-4 mb-2 text-gray-800" {...props} />,
                    p: ({ node, ...props }) => <p className="mb-4 leading-relaxed" {...props} />,
                    ul: ({ node, ...props }) => <ul className="list-disc list-inside mb-4 space-y-2" {...props} />,
                    ol: ({ node, ...props }) => <ol className="list-decimal list-inside mb-4 space-y-2" {...props} />,
                    li: ({ node, ...props }) => <li className="ml-4" {...props} />,
                    strong: ({ node, ...props }) => <strong className="font-bold text-gray-900" {...props} />,
                    code: ({ node, inline, ...props }: any) =>
                      inline ? (
                        <code className="bg-gray-100 px-1.5 py-0.5 rounded text-sm font-mono text-blue-600" {...props} />
                      ) : (
                        <code className="block bg-gray-100 p-4 rounded-lg my-4 text-sm font-mono overflow-x-auto" {...props} />
                      ),
                    blockquote: ({ node, ...props }) => <blockquote className="border-l-4 border-blue-500 pl-4 italic my-4 text-gray-600" {...props} />,
                  }}
                >
                  {planData.content}
                </ReactMarkdown>

                {/* ç”Ÿæˆä¸­çš„é—ªçƒå…‰æ ‡ */}
                {isGenerating && (
                  <span className="inline-block w-2 h-5 bg-blue-600 ml-1 animate-pulse"></span>
                )}

                {/* æ»šåŠ¨é”šç‚¹ */}
                <div ref={contentEndRef}></div>
              </div>

              {/* ç”Ÿæˆè¿›åº¦æç¤º */}
              {isGenerating && (
                <div className="mt-6 flex items-center gap-2 text-sm text-blue-600">
                  <div className="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                  <span>AI æ­£åœ¨å®æ—¶ç”Ÿæˆå†…å®¹...</span>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="border-t p-8 text-center text-gray-500 text-sm">
              <p>æœ¬å•†ä¸šè®¡åˆ’ä¹¦ç”± PitchAI è‡ªåŠ¨ç”Ÿæˆ</p>
              <p className="mt-2">ä»…ä¾›å‚è€ƒï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´</p>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
